import{D as P}from"./layout-DndgIVcP.js";import{s as n}from"./supabaseClient-C9gCct-F.js";function T(e={}){const a=(e.offer_details||{}).first_payment_date||e.repayment_start_date||e.next_payment_date;if(!a)return null;const r=new Date(a);return Number.isNaN(r.getTime())?null:r}function C(e){if(!(e instanceof Date)||Number.isNaN(e.getTime()))return null;const t=new Date(e);return t.setUTCHours(0,0,0,0),t.toISOString()}async function H(e){if(!(e!=null&&e.id))return{data:null,error:new Error("Invalid application payload")};const t=e.id,{data:a}=await n.from("loans").select("*").eq("application_id",t).maybeSingle(),r=e.offer_details||{},o=Number(e.offer_principal??e.amount??0)||0,s=Number(e.term_months||r.term_months||0)||1,u=(typeof r.interest_rate=="number"?r.interest_rate:null)??(Number(e.offer_interest_rate)?Number(e.offer_interest_rate)/100:.025);let l=Number(e.offer_monthly_repayment??r.monthly_payment??0);if(!l){const y=Math.pow(1+u,s);l=u===0?o/s:o*(u*y)/(y-1)}const h=Number(e.offer_total_repayment??r.total_repayment??(l&&s?l*s:0)),i=T(e),D=C(i),g=i?new Date(i):new Date(Date.now()+30*24*60*60*1e3);g.setUTCHours(0,0,0,0);const m={application_id:t,user_id:e.user_id,principal_amount:o,interest_rate:u,term_months:s,monthly_payment:l,status:"active",start_date:new Date().toISOString(),next_payment_date:g.toISOString(),outstanding_balance:o};if(D&&(m.first_payment_date=D),!Number.isNaN(h)&&h>0&&(m.total_repayment=h),a!=null&&a.id){const y={monthly_payment:l,next_payment_date:m.next_payment_date,interest_rate:u,term_months:s,principal_amount:o};m.total_repayment&&(y.total_repayment=m.total_repayment),m.first_payment_date&&(y.first_payment_date=m.first_payment_date);const{data:S,error:w}=await n.from("loans").update(y).eq("id",a.id).select().single();return{data:S,error:w}}const{data:b,error:_}=await n.from("loans").insert([m]).select().single();return{data:b,error:_}}const $=P.carousel_slides||[],q=(e=[])=>{const t=Array.isArray(e)?e:[];return $.map((a,r)=>{const o=t[r]||{},s=typeof o.title=="string"?o.title.trim():"",d=typeof o.text=="string"?o.text.trim():"";return{title:s||a.title,text:d||a.text}})},U=(e,t)=>{if(!e)return t;let a=`${e}`.trim().replace("#","");return a.length===3&&(a=a.split("").map(r=>r+r).join("")),/^[0-9A-Fa-f]{6}$/.test(a)?`#${a.toUpperCase()}`:t},R=(e,t=!1)=>{if(typeof e=="boolean")return e;if(typeof e=="string"){const a=e.toLowerCase();if(a==="true")return!0;if(a==="false")return!1}if(typeof e=="number"){if(e===1)return!0;if(e===0)return!1}return t},x=e=>(typeof e=="string"?e.trim():"")||P.company_name,O=(e={})=>({...P,...e,company_name:x(e==null?void 0:e.company_name),auth_overlay_color:U(e==null?void 0:e.auth_overlay_color,P.auth_overlay_color),auth_overlay_enabled:R(e==null?void 0:e.auth_overlay_enabled,P.auth_overlay_enabled),auth_background_flip:R(e==null?void 0:e.auth_background_flip,P.auth_background_flip),carousel_slides:q(e.carousel_slides)});async function Q(e){const t=crypto.randomUUID(),{data:a,error:r}=await n.from("profiles").insert([{id:t,full_name:e.fullName,identity_number:e.idNumber,contact_number:e.phone,email:e.email||null,role:"borrower"}]).select().single();return{data:a,error:r}}async function X(){try{const{data:e}=await n.rpc("get_dashboard_stats").single(),{data:t}=await n.from("payments").select("amount"),{data:a}=await n.from("loans").select("principal_amount, status"),r=(t==null?void 0:t.reduce((p,l)=>p+(Number(l.amount)||0),0))||0,o=(a==null?void 0:a.reduce((p,l)=>p+(Number(l.principal_amount)||0),0))||0;let s=0,d=0,u=0;return a==null||a.forEach(p=>{const l=(p.status||"").toLowerCase();l==="active"?s++:l==="default"||l==="arrears"?d++:(l==="repaid"||l==="settled")&&u++}),{financials:{total_disbursed:o,total_collected:r,realized_cash_flow:r,profit_margin:o>0?((r-o)/o*100).toFixed(1):0,net_profit_amount:r-o,active_loans_count:s,pending_apps:(e==null?void 0:e.pending_applications)||0},portfolioStatus:[{name:"Active",value:s},{name:"Default",value:d},{name:"Repaid",value:u}],error:null}}catch(e){return{financials:null,portfolioStatus:null,error:e.message}}}async function Z(){const{data:e,error:t}=await n.from("loan_applications").select("id, amount, status, created_at, profiles:user_id(full_name)").not("status","in","(DISBURSED,DECLINED)").order("created_at",{ascending:!1});return{data:e,error:t?t.message:null}}async function ee(){const e=new Date,t=new Date;t.setFullYear(t.getFullYear()-1);const{data:a,error:r}=await n.rpc("get_monthly_loan_performance",{start_date:t.toISOString().split("T")[0],end_date:e.toISOString().split("T")[0]});return{data:a,error:r?r.message:null}}async function te(){return n.from("loan_applications").select("*, profiles:user_id(full_name)").order("created_at",{ascending:!1})}async function ae(e){console.log(`   ðŸ”    Fetching Detail for App ID: ${e}`);const{data:t,error:a}=await n.from("loan_applications").select(`
        *,
        profiles:user_id(*),
        creator:created_by_admin(full_name, email),
        reviewer:reviewed_by_admin(full_name, email)
    `).eq("id",e).single();if(a)throw a;const r=t.user_id,[o,s,d,u,p,l,h]=await Promise.all([n.from("financial_profiles").select("*").eq("user_id",r).maybeSingle(),n.from("document_uploads").select("id, file_name, file_type, file_path, uploaded_at, status").eq("user_id",r).order("uploaded_at",{ascending:!1}),n.from("payouts").select("status").eq("application_id",e).maybeSingle(),n.from("bank_accounts").select("*").eq("user_id",r),n.from("credit_checks").select("*").eq("user_id",r).order("checked_at",{ascending:!1}),n.from("loans").select("*").eq("user_id",r).order("created_at",{ascending:!1}),n.from("loan_applications").select("id, status, amount, created_at, purpose").eq("user_id",r).neq("id",e).order("created_at",{ascending:!1})]);return{...t,financial_profiles:o.data?[o.data]:[],documents:s.data||[],payout:d.data||null,bank_accounts:u.data||[],credit_checks:p.data||[],loan_history:l.data||[],application_history:h.data||[]}}async function re(e,t){const{data:a,error:r}=await n.from("loan_applications").update({status:t}).eq("id",e).select().single();return r?{data:null,error:r}:(a&&["OFFERED","READY_TO_DISBURSE","DISBURSED","ACTIVE"].includes(t)&&await H(a),{data:a,error:null})}async function ne(e,t){const{data:a,error:r}=await n.from("loan_applications").update({notes:t}).eq("id",e).select();return{data:a,error:r}}async function oe(){return n.from("profiles").select("*").order("created_at",{ascending:!1})}async function se(e){const{data:t,error:a}=await n.from("profiles").select("*").eq("id",e).single();return{data:t,error:a}}async function ie(){try{const{data:e,error:t}=await n.rpc("get_user_stats").single();return{data:e,error:t?t.message:null}}catch(e){return{data:null,error:e.message}}}async function le(e){try{const{data:t,error:a}=await n.from("profiles").select("*").eq("id",e).single();if(a)throw a;const[r,o]=await Promise.all([n.from("financial_profiles").select("*").eq("user_id",e).maybeSingle(),n.from("loan_applications").select("*").eq("user_id",e).order("created_at",{ascending:!1})]);return{data:{profile:t,financials:r.data||null,applications:o.data||[]},error:null}}catch(t){return console.error("Fetch User Detail Error:",t),{data:null,error:t.message}}}async function ce(){return n.from("payments").select("*, profile:user_id(full_name)").order("payment_date",{ascending:!1})}async function ue(){try{const e=new Date,t=new Date;t.setFullYear(t.getFullYear()-1);const a=t.toISOString().split("T")[0],r=e.toISOString().split("T")[0],{data:o,error:s}=await n.rpc("get_payments_over_time",{start_date:a,end_date:r});return{data:o,error:s?s.message:null}}catch(e){return{data:null,error:e.message}}}async function de(e){try{const{data:t,error:a}=await n.rpc("get_payment_detail",{p_payment_id:e}).single();return{data:t,error:a?a.message:null}}catch(t){return{data:null,error:t.message}}}async function me(){return n.from("payouts").select("*, profile:user_id(full_name, email), bank_account:user_id(*)").order("created_at",{ascending:!1})}async function _e(){try{const{data:e,error:t}=await n.rpc("get_payout_stats").single();return{data:e,error:t?t.message:null}}catch(e){return{data:null,error:e.message}}}async function fe(e){try{const{data:t,error:a}=await n.rpc("get_payout_detail",{p_payout_id:e}).single();return{data:t,error:a?a.message:null}}catch(t){return{data:null,error:t.message}}}async function pe(e){const{data:t,error:a}=await n.from("payouts").update({status:"disbursed",disbursed_at:new Date().toISOString()}).eq("id",e).select();return{data:t,error:a}}async function ye(e){return n.from("payouts").insert([e])}async function he(e){return n.from("payouts").delete().eq("application_id",e)}async function ge(e){try{const{error:t}=await n.rpc("update_my_profile",{p_full_name:e.full_name,p_contact_number:e.contact_number});return{error:t?t.message:null}}catch(t){return{error:t.message}}}async function we(e,t){try{const{error:a}=await n.rpc("update_user_role",{p_user_id:e,p_new_role:t});return{error:a?a.message:null}}catch(a){return{error:a.message}}}async function De(){try{const{data:e,error:t}=await n.rpc("get_payment_methods");return{data:e,error:t?t.message:null}}catch(e){return{data:null,error:e.message}}}async function Se(e){try{const{data:t,error:a}=await n.rpc("add_payment_method",e);return{data:t,error:a?a.message:null}}catch(t){return{data:null,error:t.message}}}async function be(e){try{const{error:t}=await n.rpc("update_my_avatar",{p_avatar_url:e});return{error:t?t.message:null}}catch(t){return{error:t.message}}}async function Ee(){try{const{data:e,error:t}=await n.from("system_settings").select("*").eq("id","global").maybeSingle();if(t&&t.code!=="PGRST116")throw t;return{data:O(e),error:null}}catch(e){return{data:O(),error:e.message}}}async function Pe(e){var t;try{const{data:a}=await n.auth.getUser(),r=q(e.carousel_slides),o={id:"global",company_name:x(e.company_name),primary_color:e.primary_color,secondary_color:e.secondary_color,tertiary_color:e.tertiary_color,theme_mode:e.theme_mode,company_logo_url:e.company_logo_url||null,auth_background_url:e.auth_background_url||null,auth_background_flip:R(e.auth_background_flip,!1),auth_overlay_color:U(e.auth_overlay_color,P.auth_overlay_color),auth_overlay_enabled:R(e.auth_overlay_enabled,P.auth_overlay_enabled),carousel_slides:r,updated_by:((t=a==null?void 0:a.user)==null?void 0:t.id)||null},{data:s,error:d}=await n.from("system_settings").upsert(o,{onConflict:"id"}).select().single();return{data:O(s),error:d?d.message:null}}catch(a){return{data:null,error:a.message}}}async function j(e){try{const{data:t,error:a}=await n.from("loan_applications").select("*").eq("id",e).single();if(a)throw a;t.status!=="OFFERED"&&t.status!=="DISBURSED"&&t.status;const{data:r}=await n.from("loans").select("id").eq("application_id",e).maybeSingle();if(r)return{error:"Loan already exists"};const o=t.offer_details||{},s=o.interest_rate?parseFloat(o.interest_rate):.2,d=s/12,u=parseFloat(t.amount),p=parseInt(t.term_months),l=60,h=u*d,D=u/p+h+l,g=T(t),m=g?new Date(g):new Date(Date.now()+30*24*60*60*1e3);m.setUTCHours(0,0,0,0);const b=C(g),_={application_id:e,user_id:t.user_id,principal_amount:u,interest_rate:s,term_months:p,monthly_payment:D.toFixed(2),status:"active",start_date:new Date().toISOString(),next_payment_date:m.toISOString(),outstanding_balance:u};b&&(_.first_payment_date=b);const y=await n.from("loans").insert([_]).select().single();let S=y.data,w=y.error;if(w&&b&&/first_payment_date/i.test(w.message||"")){console.warn("âš ï¸ loans.first_payment_date column missing. Retrying insert without it.");const c={..._};delete c.first_payment_date;const f=await n.from("loans").insert([c]).select().single();S=f.data,w=f.error}if(w)throw w;return t.status!=="DISBURSED"&&await n.from("loan_applications").update({status:"DISBURSED"}).eq("id",e),{data:S,error:null}}catch(t){return{data:null,error:t.message}}}async function ve(){try{const{data:e,error:t}=await n.from("loan_applications").select("id").eq("status","OFFERED");if(t)throw t;const a=e||[],r={total:a.length,success:0,failures:[]};for(const o of a){const{data:s,error:d}=await j(o.id);d||!s?r.failures.push({id:o.id,error:d||"Unknown error"}):r.success+=1}return{data:r,error:null}}catch(e){return{data:null,error:e.message}}}async function G(){try{const{data:e,error:t}=await n.from("loans").select("id, principal_amount, interest_rate, start_date, status, user_id, term_months").not("start_date","is",null).order("start_date",{ascending:!0});if(t)throw t;const{data:a,error:r}=await n.from("payments").select("loan_id, amount, payment_date").order("payment_date",{ascending:!0});if(r)throw r;const o=[...new Set(e.map(i=>i.user_id))],{data:s}=await n.from("profiles").select("id, full_name").in("id",o),d={};s==null||s.forEach(i=>{d[i.id]=i.full_name});const u={};a.forEach(i=>{u[i.loan_id]||(u[i.loan_id]=[]),u[i.loan_id].push(i)});const p=[],l=new Date,h=l.toISOString().slice(0,7);return e.forEach(i=>{const D=u[i.id]||[],g=60;let m=Number(i.interest_rate)||0;m>1&&(m=m/100);const b=m/12;let _=Number(i.principal_amount),y=0,S=0,w=0;const c=new Date(i.start_date);let f=new Date(c);f.setDate(1);let L=0;for(;(f<=l||f.toISOString().slice(0,7)===h)&&!(L++>120);){const A=f.toISOString().slice(0,7);let F=0,I=0;_>.01&&(F=_*b,I=g),y+=F,S+=I;const Y=Number(i.principal_amount)/i.term_months,B=F+I+Y,M=D.filter(E=>E.payment_date.startsWith(A)).reduce((E,z)=>E+Number(z.amount),0);let v=M;const k=Math.min(v,S);S-=k,v-=k;const N=Math.min(v,y);if(y-=N,v-=N,_-=v,_<1&&(_=0),f>=c&&_>0){const E=B-M;E>5?w+=E:E<0&&(w=Math.max(0,w+E))}else _===0&&(w=0);if(p.push({month:A,loan_id:i.id,customer:d[i.user_id]||"Unidentified",status:i.status,principal_outstanding:_,interest_receivable:y,fee_receivable:S,arrears_amount:w,interest_earned_month:F,fees_earned_month:I,payment_received:M}),f.setMonth(f.getMonth()+1),A===h)break}}),{data:p,error:null}}catch(e){return console.error("Analytics Error:",e),{data:[],error:e.message}}}async function Fe(e="YTD"){try{const{data:t,error:a}=await G();if(a)throw new Error(a);const r=new Date;let o=new Date,s=1;switch(e){case"1M":o.setMonth(r.getMonth()-1),s=12;break;case"3M":o.setMonth(r.getMonth()-3),s=4;break;case"6M":o.setMonth(r.getMonth()-6),s=2;break;case"1Y":o.setFullYear(r.getFullYear()-1),s=1;break;case"YTD":o=new Date(r.getFullYear(),0,1),s=12/(r.getMonth()+1);break;default:o=new Date(r.getFullYear(),0,1)}const d=o.toISOString().slice(0,7),u=t.filter(c=>c.month>=d),p={};t.forEach(c=>{p[c.loan_id]=c});const l=Object.values(p),h=u.reduce((c,f)=>c+(f.interest_earned_month||0),0),i=u.reduce((c,f)=>c+(f.fees_earned_month||0),0),D=h+i,g=l.reduce((c,f)=>c+(f.principal_outstanding||0),0);let m=0;g>0&&(m=D/g*s*100);const b=l.filter(c=>(c.arrears_amount||0)>10).length,_=l.filter(c=>c.principal_outstanding>0).length||1,y=b/_*100,S=l.filter(c=>c.arrears_amount>c.principal_outstanding*.15).reduce((c,f)=>c+f.principal_outstanding,0),w=g>0?S/g*100:0;return{data:{period:e,incomeStatement:{interestIncome:h,nii:h,feeIncome:i,commissionIncome:0,penaltyIncome:0,nir:i,totalRevenue:D},ratios:{clr:w.toFixed(2)+"%",niiToRevenue:D>0?h/D*100:0,nirToRevenue:D>0?i/D*100:0},balanceSheet:{totalLoanBook:g,activeClients:_,avgLoanPerClient:_>0?g/_:0,avgInterestRate:m,arrearsPercentage:y}},error:null}}catch(t){return console.error("Financials Error:",t),{data:null,error:t.message}}}async function Ie(){const{data:e,error:t}=await n.rpc("get_portfolio_analytics");return t?(console.error("Error fetching analytics:",t),{data:{vintage:[],risk_matrix:[],funnel:{}}}):{data:e}}async function Re(){try{const{data:e,error:t}=await n.rpc("get_financial_trends");if(t)throw t;return{data:e||[]}}catch(e){return console.error("Error fetching trends:",e),{data:[]}}}export{de as A,me as B,_e as C,pe as D,fe as E,se as F,G,Z as a,ee as b,Fe as c,Ie as d,Re as e,X as f,Ee as g,oe as h,ge as i,be as j,Se as k,De as l,Pe as m,ie as n,le as o,te as p,Q as q,re as r,ve as s,ne as t,we as u,ae as v,ye as w,he as x,ce as y,ue as z};
